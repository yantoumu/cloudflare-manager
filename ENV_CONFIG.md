# ç¯å¢ƒå˜é‡é…ç½®æŒ‡å—

## å¿«é€Ÿé…ç½®ï¼ˆ3 æ­¥ï¼‰

### 1. åˆ›å»º .env æ–‡ä»¶

```bash
# å¤åˆ¶æ¨¡æ¿æ–‡ä»¶
cp .env.example .env
```

### 2. ç”Ÿæˆå¹¶é…ç½® JWT_SECRETï¼ˆå¿…é¡»ï¼ï¼‰

```bash
# ç”Ÿæˆéšæœºå¯†é’¥
openssl rand -base64 32
```

**è¾“å‡ºç¤ºä¾‹**:
```
JcATswT81oGHE9nsrBOv6DqA73qhLGGpe8NfjBg+xJk=
```

**ç¼–è¾‘ .env æ–‡ä»¶**:
```bash
nano .env
```

**å¡«å…¥å¯†é’¥**:
```bash
JWT_SECRET=JcATswT81oGHE9nsrBOv6DqA73qhLGGpe8NfjBg+xJk=
```

### 3. é…ç½®ç«¯å£ï¼ˆå¯é€‰ï¼‰

å¦‚æœ 3000 ç«¯å£è¢«å ç”¨ï¼Œä¿®æ”¹ä¸ºå…¶ä»–ç«¯å£ï¼š

```bash
# .env æ–‡ä»¶
HOST_PORT=8080  # æ”¹ä¸ºä»»æ„æœªå ç”¨çš„ç«¯å£
```

---

## å®Œæ•´é…ç½®ç¤ºä¾‹

**æœ€å°é…ç½®** (.env æ–‡ä»¶):

```bash
# å¿…å¡«é¡¹
JWT_SECRET=JcATswT81oGHE9nsrBOv6DqA73qhLGGpe8NfjBg+xJk=

# å¯é€‰é¡¹ï¼ˆå¦‚æœ 3000 ç«¯å£è¢«å ç”¨ï¼‰
HOST_PORT=8080
```

**å®Œæ•´é…ç½®** (.env æ–‡ä»¶):

```bash
# ============================================
# å®‰å…¨é…ç½®ï¼ˆå¿…å¡«ï¼ï¼‰
# ============================================
JWT_SECRET=JcATswT81oGHE9nsrBOv6DqA73qhLGGpe8NfjBg+xJk=

# ============================================
# ç«¯å£é…ç½®
# ============================================
HOST_PORT=3000          # å®¿ä¸»æœºç«¯å£ï¼ˆå¯æ”¹ï¼‰
# PORT=3000             # å®¹å™¨å†…ç«¯å£ï¼ˆé€šå¸¸ä¸éœ€è¦æ”¹ï¼‰

# ============================================
# è¿è¡Œç¯å¢ƒ
# ============================================
NODE_ENV=production     # ç”Ÿäº§ç¯å¢ƒ
DEBUG_CF_API=false      # å…³é—­è°ƒè¯•ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰

# ============================================
# å‰ç«¯é…ç½®ï¼ˆå¯é€‰ï¼‰
# ============================================
# CLIENT_URL=https://your-domain.com  # å¦‚æœå‰åç«¯åˆ†ç¦»éƒ¨ç½²
```

---

## é…ç½®ä½ç½®è¯´æ˜

### æœ¬åœ°å¼€å‘

**æ–‡ä»¶ä½ç½®**: é¡¹ç›®æ ¹ç›®å½•çš„ `.env` æ–‡ä»¶

```
cloudflare-manager/
â”œâ”€â”€ .env              â† é…ç½®æ–‡ä»¶ï¼ˆä½ è¦åˆ›å»ºçš„ï¼‰
â”œâ”€â”€ .env.example      â† æ¨¡æ¿æ–‡ä»¶
â”œâ”€â”€ docker-compose.yml
â””â”€â”€ ...
```

### Docker éƒ¨ç½²

**è¯»å–é¡ºåº**:
1. `.env` æ–‡ä»¶ï¼ˆä¼˜å…ˆï¼‰
2. `docker-compose.yml` ä¸­çš„é»˜è®¤å€¼ï¼ˆfallbackï¼‰

**éªŒè¯é…ç½®**:
```bash
# æŸ¥çœ‹å®é™…ä½¿ç”¨çš„ç¯å¢ƒå˜é‡
# Docker Compose v2 (æ–°ç‰ˆæœ¬ï¼Œæ¨è)
docker compose config

# Docker Compose v1 (æ—§ç‰ˆæœ¬)
docker-compose config

# æ³¨æ„ï¼šéƒ¨ç½²è„šæœ¬ä¼šè‡ªåŠ¨æ£€æµ‹å¹¶ä½¿ç”¨æ­£ç¡®çš„å‘½ä»¤
```

---

## ç«¯å£é…ç½®è¯¦è§£

### ç«¯å£æ˜ å°„è¯´æ˜

```yaml
# docker-compose.yml
ports:
  - "127.0.0.1:${HOST_PORT:-3000}:3000"
  #  â†‘            â†‘                â†‘
  #  |            |                â””â”€ å®¹å™¨å†…ç«¯å£ï¼ˆå›ºå®š 3000ï¼‰
  #  |            â””â”€ å®¿ä¸»æœºç«¯å£ï¼ˆä» .env è¯»å– HOST_PORTï¼Œé»˜è®¤ 3000ï¼‰
  #  â””â”€ åªç›‘å¬æœ¬åœ°ï¼ˆé€šè¿‡ Nginx è®¿é—®ï¼Œæ›´å®‰å…¨ï¼‰
```

### ç«¯å£å†²çªè§£å†³

**åœºæ™¯ 1**: 3000 ç«¯å£è¢«å ç”¨

```bash
# .env æ–‡ä»¶
HOST_PORT=8080  # æ”¹ä¸º 8080
```

**åŒæ­¥æ›´æ–° Nginx é…ç½®**:
```nginx
# /etc/nginx/sites-available/cloudflare-manager
location / {
    proxy_pass http://127.0.0.1:8080;  # æ”¹ä¸º 8080
    # ...
}
```

**åœºæ™¯ 2**: éœ€è¦å¤–éƒ¨ç›´æ¥è®¿é—®ï¼ˆä¸é€šè¿‡ Nginxï¼‰

ä¿®æ”¹ `docker-compose.yml`:
```yaml
ports:
  - "${HOST_PORT:-3000}:3000"  # ç§»é™¤ 127.0.0.1: å‰ç¼€
```

âš ï¸ **å®‰å…¨è­¦å‘Š**: ä¸æ¨èç›´æ¥æš´éœ²ï¼Œå»ºè®®ä½¿ç”¨ Nginx åå‘ä»£ç†ã€‚

---

## å¸¸ç”¨ç«¯å£é…ç½®

| ç«¯å£ | ç”¨é€” | æ¨èåœºæ™¯ |
|------|------|----------|
| 3000 | é»˜è®¤ç«¯å£ | å¼€å‘ç¯å¢ƒ |
| 8080 | å¤‡é€‰ç«¯å£ | ç”Ÿäº§ç¯å¢ƒï¼ˆå¸¸ç”¨ï¼‰ |
| 8888 | å¤‡é€‰ç«¯å£ | å¤šæœåŠ¡éƒ¨ç½² |
| 9000 | å¤‡é€‰ç«¯å£ | é¿å…å¸¸è§å†²çª |

---

## ç”Ÿæˆ JWT_SECRET çš„æ–¹æ³•

### æ–¹æ³• 1: OpenSSLï¼ˆæ¨èï¼‰

```bash
openssl rand -base64 32
```

### æ–¹æ³• 2: Python

```bash
python3 -c "import secrets; print(secrets.token_urlsafe(32))"
```

### æ–¹æ³• 3: Node.js

```bash
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"
```

### æ–¹æ³• 4: åœ¨çº¿ç”Ÿæˆå™¨ï¼ˆä¸æ¨èç”Ÿäº§ç¯å¢ƒï¼‰

```bash
# ä½¿ç”¨éƒ¨ç½²è„šæœ¬è‡ªåŠ¨ç”Ÿæˆ
bash deploy.sh  # ä¼šè‡ªåŠ¨ç”Ÿæˆå¹¶é…ç½®
```

---

## éªŒè¯é…ç½®

### æ£€æŸ¥ JWT_SECRET

```bash
# æŸ¥çœ‹é…ç½®ï¼ˆJWT_SECRET ä¼šæ˜¾ç¤ºå‰å‡ ä¸ªå­—ç¬¦ï¼‰
docker-compose config | grep JWT_SECRET
```

**æ­£ç¡®è¾“å‡º**:
```
- JWT_SECRET=JcATswT8...  # è‡³å°‘ 32 å­—ç¬¦
```

**é”™è¯¯è¾“å‡º**:
```
- JWT_SECRET=            # ç©ºå€¼ï¼Œåº”ç”¨å¯åŠ¨å¤±è´¥
- JWT_SECRET=short       # å¤ªçŸ­ï¼Œåº”ç”¨å¯åŠ¨å¤±è´¥
```

### æ£€æŸ¥ç«¯å£

```bash
# æŸ¥çœ‹å®é™…ç«¯å£æ˜ å°„
# Docker Compose v2
docker compose ps
# æˆ– Docker Compose v1
docker-compose ps

# ç›´æ¥æŸ¥çœ‹å®¹å™¨ç«¯å£
docker port cloudflare-manager
```

**é¢„æœŸè¾“å‡º**:
```
3000/tcp -> 127.0.0.1:3000  # é»˜è®¤
# æˆ–
3000/tcp -> 127.0.0.1:8080  # è‡ªå®šä¹‰
```

### æµ‹è¯•è®¿é—®

```bash
# æœ¬åœ°æµ‹è¯•
curl http://127.0.0.1:3000/health   # æˆ–ä½ é…ç½®çš„ç«¯å£

# é€šè¿‡ Nginx æµ‹è¯•
curl http://your-domain.com/health
```

---

## å¸¸è§é”™è¯¯

### é”™è¯¯ 1: JWT_SECRET æœªé…ç½®

**é”™è¯¯ä¿¡æ¯**:
```
Error: FATAL: JWT_SECRET environment variable is not set
```

**è§£å†³æ–¹æ³•**:
```bash
# 1. ç”Ÿæˆå¯†é’¥
openssl rand -base64 32

# 2. æ·»åŠ åˆ° .env
echo "JWT_SECRET=<ç”Ÿæˆçš„å¯†é’¥>" >> .env

# 3. é‡å¯å®¹å™¨
docker compose restart  # v2
# æˆ–
docker-compose restart  # v1
```

### é”™è¯¯ 2: JWT_SECRET å¤ªçŸ­

**é”™è¯¯ä¿¡æ¯**:
```
Error: FATAL: JWT_SECRET must be at least 32 characters long
```

**è§£å†³æ–¹æ³•**:
```bash
# é‡æ–°ç”Ÿæˆæ›´é•¿çš„å¯†é’¥
openssl rand -base64 48  # ç”Ÿæˆ 48 å­—èŠ‚ï¼ˆæ›´å®‰å…¨ï¼‰

# æ›´æ–° .env
```

### é”™è¯¯ 3: ç«¯å£è¢«å ç”¨

**é”™è¯¯ä¿¡æ¯**:
```
Error: bind: address already in use
```

**è§£å†³æ–¹æ³•**:
```bash
# æ–¹æ³•1: æŸ¥æ‰¾å¹¶åœæ­¢å ç”¨è¿›ç¨‹
lsof -ti:3000 | xargs kill -9

# æ–¹æ³•2: ä¿®æ”¹ç«¯å£
# ç¼–è¾‘ .env: HOST_PORT=8080
# é‡å¯: docker compose up -d  (v2) æˆ– docker-compose up -d  (v1)
```

### é”™è¯¯ 4: .env æ–‡ä»¶ä¸å­˜åœ¨

**é”™è¯¯ä¿¡æ¯**:
```
Warning: .env file not found
```

**è§£å†³æ–¹æ³•**:
```bash
# å¤åˆ¶æ¨¡æ¿
cp .env.example .env

# é…ç½® JWT_SECRET
nano .env
```

---

## å®‰å…¨å»ºè®®

### JWT_SECRET å®‰å…¨

âœ… **åº”è¯¥**:
- ä½¿ç”¨è‡³å°‘ 32 å­—ç¬¦çš„éšæœºå­—ç¬¦ä¸²
- å®šæœŸæ›´æ¢ï¼ˆä¼šå¯¼è‡´æ‰€æœ‰ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•ï¼‰
- ä¿å­˜å¤‡ä»½åˆ°å®‰å…¨ä½ç½®
- ä¸è¦æäº¤åˆ° Gitï¼ˆ.env å·²åœ¨ .gitignoreï¼‰

âŒ **ä¸è¦**:
- ä½¿ç”¨ç®€å•å¯†ç æˆ–å¯çŒœæµ‹çš„å­—ç¬¦ä¸²
- ä¸ä»–äººåˆ†äº«
- æäº¤åˆ°å…¬å¼€ä»“åº“
- åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨é»˜è®¤å€¼

### ç«¯å£å®‰å…¨

âœ… **æ¨èé…ç½®**:
```yaml
# docker-compose.yml
ports:
  - "127.0.0.1:3000:3000"  # âœ… åªå…è®¸æœ¬åœ°è®¿é—®
```

âŒ **ä¸æ¨èé…ç½®**:
```yaml
ports:
  - "3000:3000"  # âŒ å…è®¸å¤–éƒ¨ç›´æ¥è®¿é—®
```

---

## å¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# ç”Ÿæˆ JWT_SECRET
openssl rand -base64 32

# åˆ›å»º .env æ–‡ä»¶
cp .env.example .env

# ç¼–è¾‘é…ç½®
nano .env

# éªŒè¯é…ç½®
docker compose config  # v2 æˆ– docker-compose config  # v1

# åº”ç”¨é…ç½®ï¼ˆé‡å¯å®¹å™¨ï¼‰
docker compose restart  # v2 æˆ– docker-compose restart  # v1

# æŸ¥çœ‹æ—¥å¿—
docker compose logs -f  # v2 æˆ– docker-compose logs -f  # v1

# æ£€æŸ¥ç«¯å£
docker port cloudflare-manager
```

---

## æ€»ç»“

### å¿…é¡»é…ç½®

- âœ… **JWT_SECRET**: è‡³å°‘ 32 å­—ç¬¦çš„éšæœºå­—ç¬¦ä¸²

### å¯é€‰é…ç½®

- ğŸ“ **HOST_PORT**: é»˜è®¤ 3000ï¼Œæœ‰å†²çªæ—¶ä¿®æ”¹
- ğŸ“ **NODE_ENV**: é»˜è®¤ production
- ğŸ“ **CLIENT_URL**: å‰åç«¯åˆ†ç¦»æ—¶é…ç½®

### é…ç½®æ–‡ä»¶ä½ç½®

```
é¡¹ç›®æ ¹ç›®å½•/.env  â† ä½ è¦åˆ›å»ºå’Œç¼–è¾‘çš„æ–‡ä»¶
```

---

**å®Œæˆé…ç½®åè¿è¡Œ**: `docker-compose up -d`
